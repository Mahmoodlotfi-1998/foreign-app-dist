import{s as ee,j as Y,K as k,r as D,V as te,p as M,W as j,X as ne,Y as le,Z as re,$ as ue,d as I,a0 as ce,a as d,c as p,u as s,a1 as P,l as r,m as v,a2 as $,a3 as de,f as g,e as i,F as B,a4 as O,a5 as he,t as S,i as L,S as se,n as U,a6 as me,o as fe,a7 as pe,a8 as R,q as _e,w as ve,h as ge,a9 as ye,aa as we,ab as be,R as xe}from"./index-C6SLAYHp.js";import{h as Me}from"./moment-Cl4UOzQZ.js";import{_ as q,a as N,B as Ce,b as $e,c as qe}from"./BasicActionSheet.vue_vue_type_script_setup_true_lang-Bn1WKkKb.js";import{_ as Se,b as ke}from"./BasicInput.vue_vue_type_style_index_0_lang-DHfynytP.js";import{u as Ee}from"./responsiveStore-Ysp6_bE0.js";const De="/assets/logo_vertical-lACTJVlK.svg",Ie=async e=>await ee.fetch("chat","select",{column:"id",field:"request_id",value:e}),Re=async e=>await ee.fetch("pricing_requests","update",{field:"id",value:e,data:{new_message:!0}}),_=Y(),Te=k(()=>{var e;return new Date((e=u.value)==null?void 0:e.expiration_at).getTime()}),Ne=Date.now(),z=k(()=>Te.value-Ne),Be=k(()=>{var t;let e=(t=_.userRequestsInfo)==null?void 0:t.some(o=>["open","suggested","accepted"].includes(o.status));return console.log(e),!F.value||E.value===""||E.value===0||e}),Ae=k(()=>{var t,o;console.log((t=_.userBorrowerInfo)==null?void 0:t.complete_profile);let e=(o=_.userRequestsInfo)==null?void 0:o.some(n=>["open","suggested","accepted"].includes(n.status));return!F.value||e}),E=D(0);let oe;const u=k(()=>{var n,l,h;const e=(n=_.userRequestsInfo)==null?void 0:n.find(a=>a.status==="open"),t=(l=_.userRequestsInfo)==null?void 0:l.find(a=>a.status==="suggested"),o=(h=_.userRequestsInfo)==null?void 0:h.find(a=>a.status==="accepted");return t&&new Date(t==null?void 0:t.expiration_at).getTime()-Date.now()<=0&&(te(t.id).finally(),_.getRequests().finally()),console.log("salam"),e||t||(o?(Ie(o==null?void 0:o.id).then(a=>{oe=a[0].id}),o):void 0)}),F=k(()=>{var e;return(e=_.userBorrowerInfo)==null?void 0:e.complete_profile});async function Ve(e){try{M.value=!0,await j("Are you sure to cancel this request?",e??"",te,_.getRequests)}catch{}finally{M.value=!1}}async function He(e){try{await j("Are you sure to accept this request?",e??"",ne,_.getRequests)}catch(t){console.log(t)}finally{}}async function Le(e){try{await j("Are you sure to reject this request?",e??"",le,_.getRequests)}catch(t){console.log(t)}finally{}}async function je(e){try{await j("Are you sure to make call with admin?",e??"",re,_.getRequests)}catch(t){console.log(t)}finally{}}async function Ue(){var e;try{M.value=!0,await ue({income:E.value,status:"open",borrower_id:(e=_.userBorrowerInfo)==null?void 0:e.id}),await _.getRequests()}catch(t){console.log(t)}finally{M.value=!1}}const y=D(!1);function Ye(e){y.value=!0}function G(e,t="YYYY/MM/DD HH:mm:ss"){return Me.utc(e).format(t)}/*! vue-countdown v2.1.2 | (c) 2018-present Chen Fengyuan | MIT */const A=1e3,V=60*A,H=60*V,K=24*H,W="abort",J="end",X="progress",Z="start",Q="visibilitychange";var Oe=I({name:"VueCountdown",props:{autoStart:{type:Boolean,default:!0},emitEvents:{type:Boolean,default:!0},interval:{type:Number,default:1e3,validator:e=>e>=0},now:{type:Function,default:()=>Date.now()},tag:{type:String,default:"span"},time:{type:Number,default:0,validator:e=>e>=0},transform:{type:Function,default:e=>e}},emits:[W,J,X,Z],data(){return{counting:!1,endTime:0,totalMilliseconds:0,requestId:0}},computed:{days(){return Math.floor(this.totalMilliseconds/K)},hours(){return Math.floor(this.totalMilliseconds%K/H)},minutes(){return Math.floor(this.totalMilliseconds%H/V)},seconds(){return Math.floor(this.totalMilliseconds%V/A)},milliseconds(){return Math.floor(this.totalMilliseconds%A)},totalDays(){return this.days},totalHours(){return Math.floor(this.totalMilliseconds/H)},totalMinutes(){return Math.floor(this.totalMilliseconds/V)},totalSeconds(){return Math.floor(this.totalMilliseconds/A)}},watch:{$props:{deep:!0,immediate:!0,handler(){this.totalMilliseconds=this.time,this.endTime=this.now()+this.time,this.autoStart&&this.start()}}},mounted(){document.addEventListener(Q,this.handleVisibilityChange)},beforeUnmount(){document.removeEventListener(Q,this.handleVisibilityChange),this.pause()},methods:{start(){this.counting||(this.counting=!0,this.autoStart||(this.totalMilliseconds=this.time,this.endTime=this.now()+this.time),this.emitEvents&&this.$emit(Z),document.visibilityState==="visible"&&this.continue())},continue(){if(!this.counting)return;const e=Math.min(this.totalMilliseconds,this.interval);if(e>0){let t,o;const n=l=>{t||(t=l),o||(o=l);const h=l-t;h>=e||h+(l-o)/2>=e?this.progress():this.requestId=requestAnimationFrame(n),o=l};this.requestId=requestAnimationFrame(n)}else this.end()},pause(){cancelAnimationFrame(this.requestId)},progress(){this.counting&&(this.update(),this.emitEvents&&this.totalMilliseconds>0&&this.$emit(X,{days:this.days,hours:this.hours,minutes:this.minutes,seconds:this.seconds,milliseconds:this.milliseconds,totalDays:this.totalDays,totalHours:this.totalHours,totalMinutes:this.totalMinutes,totalSeconds:this.totalSeconds,totalMilliseconds:this.totalMilliseconds}),this.continue())},abort(){this.counting&&(this.pause(),this.counting=!1,this.emitEvents&&this.$emit(W))},end(){this.counting&&(this.pause(),this.totalMilliseconds=0,this.counting=!1,this.emitEvents&&this.$emit(J))},update(){this.counting&&(this.totalMilliseconds=Math.max(0,this.endTime-this.now()))},restart(){this.pause(),this.totalMilliseconds=this.time,this.endTime=this.now()+this.time,this.counting=!1,this.start()},handleVisibilityChange(){switch(document.visibilityState){case"visible":this.update(),this.continue();break;case"hidden":this.pause();break}}},render(){return ce(this.tag,this.$slots.default?[this.$slots.default(this.transform({days:this.days,hours:this.hours,minutes:this.minutes,seconds:this.seconds,milliseconds:this.milliseconds,totalDays:this.totalDays,totalHours:this.totalHours,totalMinutes:this.totalMinutes,totalSeconds:this.totalSeconds,totalMilliseconds:this.totalMilliseconds}))]:void 0)}});const Fe=i("img",{src:De,alt:"",class:"w-1/2 mt-20"},null,-1),Pe={key:0,class:"rounded-lg p-2 border-solid border-1 mt-10"},ze=i("div",null,"Please verify yourself by completing your information.",-1),Ge={class:"rounded-lg p-2 border-solid border-1 mt-10 w-full"},Ke={key:0},We=i("div",null,"Please tell us your income:",-1),Je=i("div",{class:"font-bold text-lg mb-2"},"In progress request:",-1),Xe={key:0,class:"border-1 rounded-lg my-2 p-2"},Ze=i("div",null,"Expire Time:",-1),Qe={class:"flex gap-2 justify-evenly my-2"},et={class:"justify-items-center"},tt={class:"countDown"},st=i("div",{class:"text-xs"},"Days",-1),ot={class:"justify-items-center"},it={class:"countDown"},at=i("div",{class:"text-xs"},"Hours",-1),nt={class:"justify-items-center"},lt={class:"countDown"},rt=i("div",{class:"text-xs"},"Minutes",-1),ut={class:"justify-items-center"},ct={class:"countDown"},dt=i("div",{class:"text-xs"},"Seconds",-1),ht={key:2,class:"flex gap-2 mt-2 w-full"},mt={key:3,class:"text-gray-500 mt-2 text-xs"},ft={key:4,class:"w-full flex gap-2 mt-2"},pt={key:1,class:"flex justify-center"},ie=I({__name:"Core",setup(e){return(t,o)=>{var l,h,a;const n=se;return d(),p(B,null,[Fe,!s(F)&&!s(P)?(d(),p("div",Pe,[ze,r(de,{type:"primary",class:"w-full mt-5",onClick:o[0]||(o[0]=c=>t.$router.push({name:"user"}))},{default:v(()=>[$("Complete information ")]),_:1})])):g("",!0),i("div",Ge,[s(P)?(d(),p("div",pt,[r(n,{size:"large",tip:"Fetching data"})])):(d(),p("div",Ke,[s(u)?(d(),p(B,{key:1},[Je,i("div",null,[s(u).status==="suggested"?(d(),p("div",Xe,[Ze,r(s(Oe),{time:s(z)},{default:v(({days:c,hours:w,minutes:C,seconds:m})=>[i("div",Qe,[i("div",et,[i("div",tt,S(c),1),st]),i("div",ot,[i("div",it,S(w),1),at]),i("div",nt,[i("div",lt,S(C),1),rt]),i("div",ut,[i("div",ct,S(m),1),dt])])]),_:1},8,["time"])])):g("",!0),r(N,{title:"Status",value:(l=s(u))==null?void 0:l.status},null,8,["value"]),r(N,{title:"Date",value:s(G)((h=s(u))==null?void 0:h.created_at,"YYYY-MM-DD")},null,8,["value"]),r(N,{title:"Time",value:s(G)((a=s(u))==null?void 0:a.created_at,"HH:mm:ss")},null,8,["value"]),s(u).status==="suggested"||s(u).status==="accepted"?(d(),L(N,{key:1,title:"Pricing",value:s(u).pricing_details+"%"},null,8,["value"])):g("",!0),s(u).status==="accepted"?(d(),p("div",ht,[r(q,{icon:"vuesax-linear:call",class:"w-full border-green-600 text-green-600",disabled:s(u).call_request,onClick:o[3]||(o[3]=c=>s(je)(s(u).id))},{default:v(()=>[$("Call")]),_:1},8,["disabled"]),r(q,{icon:"vuesax-linear:message",class:"w-full border-orange-600 text-orange-600",onClick:o[4]||(o[4]=c=>s(Ye)(s(u).id))},{default:v(()=>[$("Message")]),_:1})])):g("",!0),s(u).call_request&&s(u).status==="accepted"?(d(),p("div",mt,"Call request sent. please be patient to calling admin with you.")):g("",!0),i("div",null,[s(u).status==="open"?(d(),L(q,{key:0,class:"w-full mt-2",danger:"",onClick:o[5]||(o[5]=c=>s(Ve)(s(u).id))},{default:v(()=>[$("Cancel ")]),_:1})):g("",!0)]),s(z)>0&&s(u).status==="suggested"?(d(),p("div",ft,[r(q,{class:"flex-1 bg-green-6 text-white border-green-6",loading:s(M),onClick:o[6]||(o[6]=c=>s(He)(s(u).id))},{default:v(()=>[$("Accept ")]),_:1},8,["loading"]),r(q,{class:"flex-1 bg-red-6 text-white border-red-6",loading:s(M),onClick:o[7]||(o[7]=c=>s(Le)(s(u).id))},{default:v(()=>[$("Reject ")]),_:1},8,["loading"])])):g("",!0)])],64)):(d(),p(B,{key:0},[We,r(Se,{class:"mt-2",value:s(E),"onUpdate:value":o[1]||(o[1]=c=>O(E)?E.value=c:null),disabled:s(Ae),type:"number","addon-after":"$",onClick:s(he)},null,8,["value","disabled","onClick"]),r(q,{type:"primary",loading:s(M),class:"w-full mt-5",disabled:s(Be),onClick:o[2]||(o[2]=c=>s(Ue)())},{default:v(()=>[$("Request pricing! ")]),_:1},8,["loading","disabled"])],64))]))])],64)}}}),_t=I({__name:"BasicTextArea",props:{title:{},value:{},showCount:{type:Boolean},maxlength:{},placeHolder:{},rows:{}},emits:["update:value"],setup(e,{emit:t}){const o=e,n=t,l=k({get(){return o.value},set(a){n("update:value",a)}}),{prefixCls:h}=me("input-area");return(a,c)=>{const w=ke;return d(),p("div",{class:U([s(h)])},[i("div",null,S(o.title),1),r(w,{value:l.value,"onUpdate:value":c[0]||(c[0]=C=>l.value=C),class:"",type:o.type,maxlength:a.maxlength,"show-count":o.showCount,rows:a.rows,placeHolder:o.placeHolder},null,8,["value","type","maxlength","show-count","rows","placeHolder"])],2)}}});function vt(e){const t=D([]),o=D(!0),n=Y(),l=async()=>{const{data:m,error:f}=await R.from("chat").select("chat_log").eq("id",e).single();if(f){console.error("Error fetching chat log:",f);return}t.value=(m==null?void 0:m.chat_log)||[],console.log(t.value),o.value=!1},h=async m=>{var x,T;t.value.push(m);const{error:f}=await R.from("chat").update({chat_log:t.value}).eq("id",e),{addNotification:b}=_e((x=n.userInfo)==null?void 0:x.id);b("New message",{},`You have new message from ${(T=n.userBorrowerInfo)==null?void 0:T.owner_name_formatted} please check Calls & messages!`),f&&console.error("Error updating chat log:",f)},a=async(m,f)=>{if(!t.value[m])return;t.value[m].status=f;const{error:b}=await R.from("chat").update({chat_log:t.value}).eq("id",e);b&&console.error("Error updating message status:",b)},c=()=>{t.value.forEach((m,f)=>{m.status==="delivered"&&m.sender!=="borrower"&&a(f,"read")})},w=()=>{R.channel(`realtime:chat:${e}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"chat",filter:`id=eq.${e}`},m=>{t.value=m.new.chat_log||[],t.value.forEach((f,b)=>{f.status==="sent"&&f.sender!=="borrower"&&a(b,"delivered")})}).subscribe()},C=()=>{R.removeChannel(`realtime:chat:${e}`)};return fe(()=>{l(),w()}),pe(()=>{C()}),{chatLog:t,appendMessage:h,markMessagesAsRead:c,loading:o}}const gt={class:"h65vh"},yt={class:"chat-display"},wt={class:"absolute bottom-0 right-0 left-0 bg-white z-20"},bt={class:"flex items-center p-3 w-full gap-3"},xt=I({__name:"Chat",setup(e){const{chatLog:t,loading:o,markMessagesAsRead:n,appendMessage:l}=vt(oe);let h=!0;n();const a=D(""),c=D(null),w=async()=>{await ye(),c.value&&(c.value.scrollTop=c.value.scrollHeight)};ve(t,()=>{w()});const C=()=>{var f;if(!a.value.trim())return;const m={sender:"me",message:a.value,status:"sent",timestamp:new Date().toISOString()};h&&(Re((f=u.value)==null?void 0:f.id),h=!1),l(m),a.value="",w()};return(m,f)=>{const b=se;return d(),p("div",gt,[i("div",null,[i("div",yt,[r(b,{spinning:s(o)},{default:v(()=>[i("div",{class:"h-65vh pb-20 overflow-y-auto",ref_key:"chatContainer",ref:c},[(d(!0),p(B,null,ge(s(t),(x,T)=>(d(),p("div",{key:T,class:"flex relative flex-col mt-1"},[i("div",{class:U(x.sender!=="me"?"bg-gray-300 w-fit px-2 py-1 rounded-xl z-10":"bg-green self-end w-fit px-2 py-1 rounded-xl text-white z-10")},S(x.message),3),i("div",{class:U(x.sender!=="me"?"bg-gray-300 absolute bottom-0 left-0 h-2 w-2":"bg-green absolute bottom-0 right-0 h-2 w-2")},null,2)]))),128))],512)]),_:1},8,["spinning"])])]),i("div",wt,[i("div",bt,[r(_t,{class:"!h-full w-full","place-holder":"",value:a.value,"onUpdate:value":f[0]||(f[0]=x=>a.value=x),rows:2},null,8,["value"]),r(q,{shape:"circle",type:"primary",class:"aspect-square",size:"large",icon:"vuesax-linear:send-1",onClick:C,disabled:a.value===""},null,8,["disabled"])])])])}}}),ae=we(xt,[["__scopeId","data-v-991ed3d0"]]),Mt={class:"mt-10 flex flex-col justify-center items-center"},Ct={class:"w-28rem flex flex-col justify-center items-center"},$t=I({__name:"full",setup(e){return(t,o)=>{const n=be;return d(),p("div",Mt,[i("div",Ct,[r(ie)]),r(n,{visible:s(y),"onUpdate:visible":o[0]||(o[0]=l=>O(y)?y.value=l:null),width:"30rem",title:"Support","custom-footer":"",loading:s(M)},{default:v(()=>[s(y)?(d(),L(ae,{key:0})):g("",!0)]),_:1},8,["visible","loading"])])}}}),qt={class:"flex flex-col items-center"},St={class:"fixed w-full px5"},kt={class:"rounded-lg p-2 border-solid border-1 w-full flex justify-between items-center"},Et=i("div",{class:"font-bold text-lg"},"Support",-1),Dt=I({__name:"mobile",setup(e){const t=Y();return(o,n)=>{var h;const l=qe;return d(),p("div",qt,[i("div",St,[i("div",kt,[i("div",{onClick:n[0]||(n[0]=a=>o.$router.push({name:"user"}))},"+"+S((h=s(t).userInfo)==null?void 0:h.phone),1),r(Ce,{icon:"vuesax-linear:logout",color:"red",onClick:n[1]||(n[1]=a=>s(xe)())})])]),r(ie),r($e,{show:s(y),"onUpdate:show":n[2]||(n[2]=a=>O(y)?y.value=a:null)},{default:v(()=>[i("div",null,[Et,r(l,{class:"my-2"}),s(y)?(d(),L(ae,{key:0})):g("",!0)])]),_:1},8,["show"])])}}}),It=Ee(),Vt=It.isMobile?Dt:$t;export{Vt as default};
